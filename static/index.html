<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Presidente</title>
  <link rel="icon" type="image/png" href="/elpres/crown.png">
  <link rel="apple-touch-icon" href="/elpres/app.png">
  <link rel="stylesheet" href="/elpres/style.css">
</head>
<body class="lobby">
  <main>
    <div class="panel-crown" aria-hidden="true"><img src="/elpres/crown.png" alt=""></div>
    <h1>El Presidente</h1>
    <p class="subtitle">Card game for 2â€“7 players</p>
    <form id="join-form">
      <label for="room">Room name</label>
      <input type="text" id="room" name="room" placeholder="Enter room name" required autocomplete="off" maxlength="20">
      <label for="name">Your name</label>
      <input type="text" id="name" name="name" placeholder="Your name" required maxlength="20" value="">
      <button type="submit" id="join-btn">Enter</button>
    </form>
  </main>
  <script src="/elpres/app.js"></script>
  <script>
    (function() {
      const form = document.getElementById('join-form');
      const roomInput = document.getElementById('room');
      const nameInput = document.getElementById('name');
      const LAST_ROOM_KEY = 'elpres_last_room';
      const LAST_NAME_KEY = 'elpres_last_name';

      roomInput.addEventListener('input', function() {
        roomInput.value = roomInput.value.toLowerCase().replace(/[^a-z0-9_-]/g, '').slice(0, 20);
      });

      try {
        var urlRoom = new URLSearchParams(window.location.search).get('room');
        if (urlRoom && typeof urlRoom === 'string' && urlRoom.trim()) {
          roomInput.value = urlRoom.trim().toLowerCase().replace(/[^a-z0-9_-]/g, '').slice(0, 20);
        } else {
          var lastRoom = localStorage.getItem(LAST_ROOM_KEY);
          if (lastRoom && typeof lastRoom === 'string') {
            roomInput.value = lastRoom.toLowerCase().replace(/[^a-z0-9_-]/g, '').slice(0, 20);
          }
        }
        var lastName = localStorage.getItem(LAST_NAME_KEY);
        if (lastName && typeof lastName === 'string') {
          nameInput.value = lastName.slice(0, 20);
        }
      } catch (_) {}

      function goToRoom() {
        var rawRoom = roomInput.value.trim().toLowerCase();
        var room = rawRoom.replace(/[^a-z0-9_-]/g, '');
        if (room !== rawRoom) {
          alert('Room name can only contain letters, numbers, hyphens, and underscores');
          return;
        }
        if (!room) { alert('Please enter a room name'); return; }
        if (room.length > 20) {
          alert('Room name must be 20 characters or less');
          return;
        }
        var name = nameInput.value.trim();
        if (!name) { alert('Please enter your name'); return; }
        if (name.length > 20) {
          alert('Name must be 20 characters or less');
          return;
        }
        const url = '/elpres/join?room=' + encodeURIComponent(room) + '&name=' + encodeURIComponent(name);
        fetch(url)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.error) {
              alert(data.error);
              return;
            }
            var id = data.id;
            if (!id) { alert('Invalid response'); return; }
            try {
              localStorage.setItem(LAST_ROOM_KEY, room);
              localStorage.setItem(LAST_NAME_KEY, name);
            } catch (_) {}
            window.location.href = '/elpres/room/' + encodeURIComponent(room) + '?id=' + encodeURIComponent(id);
          })
          .catch(function() { alert('Could not join room'); });
      }

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        goToRoom();
        return false;
      });
      document.getElementById('join-btn').addEventListener('click', function(e) {
        e.preventDefault();
        goToRoom();
      });
    })();
  </script>
</body>
</html>
